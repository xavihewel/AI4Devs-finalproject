e0cfbeb20f6971f7ea60b1484075ecdd
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.subscribePush = subscribePush;
exports.unsubscribePush = unsubscribePush;
exports.listSubscriptions = listSubscriptions;
const env_1 = require("../env");
function getNotificationsBaseUrl() {
    // Notification service is exposed under /api at port 8085 in dev
    const base = env_1.env.VITE_API_NOTIFICATIONS || "http://localhost:8085/api";
    return `${base}/notifications`;
}
async function subscribePush(registrationOrPayload) {
    if (isPayload(registrationOrPayload)) {
        return fetch(`${getNotificationsBaseUrl()}/subscribe`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify(registrationOrPayload),
        });
    }
    const registration = registrationOrPayload;
    const existing = await registration.pushManager.getSubscription();
    const vapidPublicKey = env_1.env.VAPID_PUBLIC_KEY;
    if (!vapidPublicKey)
        throw new Error("Missing VAPID public key");
    const convertedVapidKey = urlBase64ToUint8Array(vapidPublicKey);
    const subscription = existing ||
        (await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: new Uint8Array(convertedVapidKey),
        }));
    const { endpoint, keys } = subscription.toJSON();
    const payload = {
        endpoint,
        p256dhKey: keys.p256dh,
        authKey: keys.auth,
    };
    return fetch(`${getNotificationsBaseUrl()}/subscribe`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify(payload),
    });
}
async function unsubscribePush(registrationOrEndpoint) {
    if (typeof registrationOrEndpoint === "string") {
        return fetch(`${getNotificationsBaseUrl()}/unsubscribe?endpoint=${encodeURIComponent(registrationOrEndpoint)}`, {
            method: "DELETE",
            credentials: "include",
        });
    }
    const registration = registrationOrEndpoint;
    const existing = await registration.pushManager.getSubscription();
    if (!existing) {
        return new Response(JSON.stringify({ message: "No subscription" }), { status: 200 });
    }
    const { endpoint } = existing.toJSON();
    const resp = await fetch(`${getNotificationsBaseUrl()}/unsubscribe?endpoint=${encodeURIComponent(endpoint)}`, {
        method: "DELETE",
        credentials: "include",
    });
    try {
        await existing.unsubscribe();
    }
    catch (_) { }
    return resp;
}
async function listSubscriptions() {
    return fetch(`${getNotificationsBaseUrl()}/subscriptions`, {
        method: "GET",
        credentials: "include",
    });
}
function urlBase64ToUint8Array(base64String) {
    const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
    const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
    const rawData = atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
}
function isPayload(x) {
    return x && typeof x === "object" && typeof x.endpoint === "string" && typeof x.p256dhKey === "string" && typeof x.authKey === "string";
}
// duplicate legacy exports removed
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2FkbWluL0RvY3VtZW50cy9BSTREZXZzLWZpbmFscHJvamVjdC9Gcm9udGVuZC9zcmMvYXBpL25vdGlmaWNhdGlvbnMudHMiLCJtYXBwaW5ncyI6Ijs7QUFjQSxzQ0F3Q0M7QUFFRCwwQ0FxQkM7QUFFRCw4Q0FLQztBQXBGRCxnQ0FBNkI7QUFRN0IsU0FBUyx1QkFBdUI7SUFDOUIsaUVBQWlFO0lBQ2pFLE1BQU0sSUFBSSxHQUFJLFNBQVcsQ0FBQyxzQkFBc0IsSUFBSSwyQkFBMkIsQ0FBQztJQUNoRixPQUFPLEdBQUcsSUFBSSxnQkFBZ0IsQ0FBQztBQUNqQyxDQUFDO0FBRU0sS0FBSyxVQUFVLGFBQWEsQ0FBQyxxQkFBMEU7SUFDNUcsSUFBSSxTQUFTLENBQUMscUJBQXFCLENBQUMsRUFBRSxDQUFDO1FBQ3JDLE9BQU8sS0FBSyxDQUFDLEdBQUcsdUJBQXVCLEVBQUUsWUFBWSxFQUFFO1lBQ3JELE1BQU0sRUFBRSxNQUFNO1lBQ2QsT0FBTyxFQUFFLEVBQUUsY0FBYyxFQUFFLGtCQUFrQixFQUFFO1lBQy9DLFdBQVcsRUFBRSxTQUFTO1lBQ3RCLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLHFCQUFxQixDQUFDO1NBQzVDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxNQUFNLFlBQVksR0FBRyxxQkFBcUIsQ0FBQztJQUMzQyxNQUFNLFFBQVEsR0FBRyxNQUFNLFlBQVksQ0FBQyxXQUFXLENBQUMsZUFBZSxFQUFFLENBQUM7SUFDbEUsTUFBTSxjQUFjLEdBQUcsU0FBRyxDQUFDLGdCQUFnQixDQUFDO0lBQzVDLElBQUksQ0FBQyxjQUFjO1FBQUUsTUFBTSxJQUFJLEtBQUssQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO0lBRWpFLE1BQU0saUJBQWlCLEdBQUcscUJBQXFCLENBQUMsY0FBYyxDQUFDLENBQUM7SUFDaEUsTUFBTSxZQUFZLEdBQ2hCLFFBQVE7UUFDUixDQUFDLE1BQU0sWUFBWSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUM7WUFDeEMsZUFBZSxFQUFFLElB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R0FBRyxPQUFPLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUM7UUFDeEMsV0FBVyxDQUFDLENBQUMsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDekMsQ0FBQztJQUNELE9BQU8sV0FBVyxDQUFDO0FBQ3JCLENBQUM7QUFFRCxTQUFTLFNBQVMsQ0FBQyxDQUFNO0lBQ3ZCLE9BQU8sQ0FBQyxJQUFJLE9BQU8sQ0FBQyxLQUFLLFFBQVEsSUFBSSxPQUFPLENBQUMsQ0FBQyxRQUFRLEtBQUssUUFBUSxJQUFJLE9BQU8sQ0FBQyxDQUFDLFNBQVMsS0FBSyxRQUFRLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxLQUFLLFFBQVEsQ0FBQztBQUMxSSxDQUFDO0FBRUQsbUNBQW1DIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9hZG1pbi9Eb2N1bWVudHMvQUk0RGV2cy1maW5hbHByb2plY3QvRnJvbnRlbmQvc3JjL2FwaS9ub3RpZmljYXRpb25zLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGVudiB9IGZyb20gXCIuLi9lbnZcIjtcblxuZXhwb3J0IHR5cGUgUHVzaFN1YnNjcmlwdGlvblBheWxvYWQgPSB7XG4gIGVuZHBvaW50OiBzdHJpbmc7XG4gIHAyNTZkaEtleTogc3RyaW5nO1xuICBhdXRoS2V5OiBzdHJpbmc7XG59O1xuXG5mdW5jdGlvbiBnZXROb3RpZmljYXRpb25zQmFzZVVybCgpOiBzdHJpbmcge1xuICAvLyBOb3RpZmljYXRpb24gc2VydmljZSBpcyBleHBvc2VkIHVuZGVyIC9hcGkgYXQgcG9ydCA4MDg1IGluIGRldlxuICBjb25zdCBiYXNlID0gKGVudiBhcyBhbnkpLlZJVEVfQVBJX05PVElGSUNBVElPTlMgfHwgXCJodHRwOi8vbG9jYWxob3N0OjgwODUvYXBpXCI7XG4gIHJldHVybiBgJHtiYXNlfS9ub3RpZmljYXRpb25zYDtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHN1YnNjcmliZVB1c2gocmVnaXN0cmF0aW9uT3JQYXlsb2FkOiBTZXJ2aWNlV29ya2VyUmVnaXN0cmF0aW9uIHwgUHVzaFN1YnNjcmlwdGlvblBheWxvYWQpOiBQcm9taXNlPFJlc3BvbnNlPiB7XG4gIGlmIChpc1BheWxvYWQocmVnaXN0cmF0aW9uT3JQYXlsb2FkKSkge1xuICAgIHJldHVybiBmZXRjaChgJHtnZXROb3RpZmljYXRpb25zQmFzZVVybCgpfS9zdWJzY3JpYmVgLCB7XG4gICAgICBtZXRob2Q6IFwiUE9TVFwiLFxuICAgICAgaGVhZGVyczogeyBcIkNvbnRlbnQtVHlwZVwiOiBcImFwcGxpY2F0aW9uL2pzb25cIiB9LFxuICAgICAgY3JlZGVudGlhbHM6IFwiaW5jbHVkZVwiLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkocmVnaXN0cmF0aW9uT3JQYXlsb2FkKSxcbiAgICB9KTtcbiAgfVxuXG4gIGNvbnN0IHJlZ2lzdHJhdGlvbiA9IHJlZ2lzdHJhdGlvbk9yUGF5bG9hZDtcbiAgY29uc3QgZXhpc3RpbmcgPSBhd2FpdCByZWdpc3RyYXRpb24ucHVzaE1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uKCk7XG4gIGNvbnN0IHZhcGlkUHVibGljS2V5ID0gZW52LlZBUElEX1BVQkxJQ19LRVk7XG4gIGlmICghdmFwaWRQdWJsaWNLZXkpIHRocm93IG5ldyBFcnJvcihcIk1pc3NpbmcgVkFQSUQgcHVibGljIGtleVwiKTtcblxuICBjb25zdCBjb252ZXJ0ZWRWYXBpZEtleSA9IHVybEJhc2U2NFRvVWludDhBcnJheSh2YXBpZFB1YmxpY0tleSk7XG4gIGNvbnN0IHN1YnNjcmlwdGlvbiA9XG4gICAgZXhpc3RpbmcgfHxcbiAgICAoYXdhaXQgcmVnaXN0cmF0aW9uLnB1c2hNYW5hZ2VyLnN1YnNjcmliZSh7XG4gICAgICB1c2VyVmlzaWJsZU9ubHk6IHRydWUsXG4gICAgICBhcHBsaWNhdGlvblNlcnZlcktleTogbmV3IFVpbnQ4QXJyYXkoY29udmVydGVkVmFwaWRLZXkpLFxuICAgIH0pKTtcblxuICBjb25zdCB7IGVuZHBvaW50LCBrZXlzIH0gPSBzdWJzY3JpcHRpb24udG9KU09OKCkgYXMge1xuICAgIGVuZHBvaW50OiBzdHJpbmc7XG4gICAga2V5czogeyBwMjU2ZGg6IHN0cmluZzsgYXV0aDogc3RyaW5nIH07XG4gIH07XG5cbiAgY29uc3QgcGF5bG9hZDogUHVzaFN1YnNjcmlwdGlvblBheWxvYWQgPSB7XG4gICAgZW5kcG9pbnQsXG4gICAgcDI1NmRoS2V5OiBrZXlzLnAyNTZkaCxcbiAgICBhdXRoS2V5OiBrZXlzLmF1dGgsXG4gIH07XG5cbiAgcmV0dXJuIGZldGNoKGAke2dldE5vdGlmaWNhdGlvbnNCYXNlVXJsKCl9L3N1YnNjcmliZWAsIHtcbiAgICBtZXRob2Q6IFwiUE9TVFwiLFxuICAgIGhlYWRlcnM6IHsgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIgfSxcbiAgICBjcmVkZW50aWFsczogXCJpbmNsdWRlXCIsXG4gICAgYm9keTogSlNPTi5zdHJpbmdpZnkocGF5bG9hZCksXG4gIH0pO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdW5zdWJzY3JpYmVQdXNoKHJlZ2lzdHJhdGlvbk9yRW5kcG9pbnQ6IFNlcnZpY2VXb3JrZXJSZWdpc3RyYXRpb24gfCBzdHJpbmcpOiBQcm9taXNlPFJlc3BvbnNlPiB7XG4gIGlmICh0eXBlb2YgcmVnaXN0cmF0aW9uT3JFbmRwb2ludCA9PT0gXCJzdHJpbmdcIikge1xuICAgIHJldHVybiBmZXRjaChgJHtnZXROb3RpZmljYXRpb25zQmFzZVVybCgpfS91bnN1YnNjcmliZT9lbmRwb2ludD0ke2VuY29kZVVSSUNvbXBvbmVudChyZWdpc3RyYXRpb25PckVuZHBvaW50KX1gLCB7XG4gICAgICBtZXRob2Q6IFwiREVMRVRFXCIsXG4gICAgICBjcmVkZW50aWFsczogXCJpbmNsdWRlXCIsXG4gICAgfSk7XG4gIH1cbiAgY29uc3QgcmVnaXN0cmF0aW9uID0gcmVnaXN0cmF0aW9uT3JFbmRwb2ludDtcbiAgY29uc3QgZXhpc3RpbmcgPSBhd2FpdCByZWdpc3RyYXRpb24ucHVzaE1hbmFnZXIuZ2V0U3Vic2NyaXB0aW9uKCk7XG4gIGlmICghZXhpc3RpbmcpIHtcbiAgICByZXR1cm4gbmV3IFJlc3BvbnNlKEpTT04uc3RyaW5naWZ5KHsgbWVzc2FnZTogXCJObyBzdWJzY3JpcHRpb25cIiB9KSwgeyBzdGF0dXM6IDIwMCB9KTtcbiAgfVxuICBjb25zdCB7IGVuZHBvaW50IH0gPSBleGlzdGluZy50b0pTT04oKSBhcyB7IGVuZHBvaW50OiBzdHJpbmcgfTtcbiAgY29uc3QgcmVzcCA9IGF3YWl0IGZldGNoKGAke2dldE5vdGlmaWNhdGlvbnNCYXNlVXJsKCl9L3Vuc3Vic2NyaWJlP2VuZHBvaW50PSR7ZW5jb2RlVVJJQ29tcG9uZW50KGVuZHBvaW50KX1gLCB7XG4gICAgbWV0aG9kOiBcIkRFTEVURVwiLFxuICAgIGNyZWRlbnRpYWxzOiBcImluY2x1ZGVcIixcbiAgfSk7XG4gIHRyeSB7XG4gICAgYXdhaXQgZXhpc3RpbmcudW5zdWJzY3JpYmUoKTtcbiAgfSBjYXRjaCAoXykge31cbiAgcmV0dXJuIHJlc3A7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBsaXN0U3Vic2NyaXB0aW9ucygpOiBQcm9taXNlPFJlc3BvbnNlPiB7XG4gIHJldHVybiBmZXRjaChgJHtnZXROb3RpZmljYXRpb25zQmFzZVVybCgpfS9zdWJzY3JpcHRpb25zYCwge1xuICAgIG1ldGhvZDogXCJHRVRcIixcbiAgICBjcmVkZW50aWFsczogXCJpbmNsdWRlXCIsXG4gIH0pO1xufVxuXG5mdW5jdGlvbiB1cmxCYXNlNjRUb1VpbnQ4QXJyYXkoYmFzZTY0U3RyaW5nOiBzdHJpbmcpOiBVaW50OEFycmF5IHtcbiAgY29uc3QgcGFkZGluZyA9IFwiPVwiLnJlcGVhdCgoNCAtIChiYXNlNjRTdHJpbmcubGVuZ3RoICUgNCkpICUgNCk7XG4gIGNvbnN0IGJhc2U2NCA9IChiYXNlNjRTdHJpbmcgKyBwYWRkaW5nKS5yZXBsYWNlKC8tL2csIFwiK1wiKS5yZXBsYWNlKC9fL2csIFwiL1wiKTtcbiAgY29uc3QgcmF3RGF0YSA9IGF0b2IoYmFzZTY0KTtcbiAgY29uc3Qgb3V0cHV0QXJyYXkgPSBuZXcgVWludDhBcnJheShyYXdEYXRhLmxlbmd0aCk7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgcmF3RGF0YS5sZW5ndGg7ICsraSkge1xuICAgIG91dHB1dEFycmF5W2ldID0gcmF3RGF0YS5jaGFyQ29kZUF0KGkpO1xuICB9XG4gIHJldHVybiBvdXRwdXRBcnJheTtcbn1cblxuZnVuY3Rpb24gaXNQYXlsb2FkKHg6IGFueSk6IHggaXMgUHVzaFN1YnNjcmlwdGlvblBheWxvYWQge1xuICByZXR1cm4geCAmJiB0eXBlb2YgeCA9PT0gXCJvYmplY3RcIiAmJiB0eXBlb2YgeC5lbmRwb2ludCA9PT0gXCJzdHJpbmdcIiAmJiB0eXBlb2YgeC5wMjU2ZGhLZXkgPT09IFwic3RyaW5nXCIgJiYgdHlwZW9mIHguYXV0aEtleSA9PT0gXCJzdHJpbmdcIjtcbn1cblxuLy8gZHVwbGljYXRlIGxlZ2FjeSBleHBvcnRzIHJlbW92ZWRcblxuXG4iXSwidmVyc2lvbiI6M30=